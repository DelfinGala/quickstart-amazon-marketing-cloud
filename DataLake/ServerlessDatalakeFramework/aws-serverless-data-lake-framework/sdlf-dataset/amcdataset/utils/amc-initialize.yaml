AWSTemplateFormatVersion: 2010-09-09
Description: "The following template creates an S3 Bucket and S3 Bucket policy with prescribed parameter values 
              to enable cross account write access for the parameterized AWS account."
 
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Initialization Values"
        Parameters:
          - pBucketName
          - pCrossAccountAccessAccountId
 
    ParameterLabels:
      pBucketName:
        default: "[DO NOT MODIFY] Name of S3 bucket to create."
      pCrossAccountAccessAccountId:
        default: "[DO NOT MODIFY] AWS Account ID of the account given PutObject permissions to the bucket."
 
Parameters:
  pBucketName:
    Type: String
    Description: Creates the S3 Bucket with the specified name
  pCrossAccountAccessAccountId:
    Type: String
    Description: The AWS account ID that is given PutObject access to the S3 bucket created in the template
 
Resources:
  rS3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Ref pBucketName
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: True
        BlockPublicPolicy: True
        IgnorePublicAcls: True
        RestrictPublicBuckets: True
      NotificationConfiguration:
        QueueConfigurations:
          - Event: 's3:ObjectCreated:*'
            Queue: '{{resolve:ssm:/SDLF/SQS/QueueCatalogArn:2}}'
          - Event: 's3:ObjectRemoved:*'
            Queue: '{{resolve:ssm:/SDLF/SQS/QueueCatalogArn:2}}'
 
  rS3BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref rS3Bucket
      PolicyDocument:
        Version: '2012-10-17'
        Id: BucketDeliveryPolicy
        Statement:
        - Sid: BucketDelivery
          Effect: Allow
          Principal:
            AWS: !Sub arn:aws:iam::${pCrossAccountAccessAccountId}:root
          Action:
          - s3:PutObject
          - s3:PutObjectAcl
          Resource: !Sub arn:aws:s3:::${pBucketName}/*
        - Sid: BucketOwnerAccess
          Effect: Allow
          Principal:
            AWS: !Sub arn:aws:iam::${AWS::AccountId}:root
          Action: s3:*
          Resource:
          - !Sub arn:aws:s3:::${pBucketName}/*
          - !Sub arn:aws:s3:::${pBucketName}
 
Outputs:
  oBucketName:
    Value: !Sub ${pBucketName}
    Export: 
      Name: !Sub ${AWS::StackName}-bucket

AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Contains all the resources necessary for the workflow management microservice
Parameters:
  pTeamName:
    Description: Name of the Team that owns the service Instance
    Type: String
    AllowedPattern: '[a-z0-9]{2,10}'
  pMicroserviceName:
    Description: Name of the Service being Deployed
    Type: String
    AllowedPattern: '[a-z0-9]{2,12}'
  pEnvironment:
    Description: Environment name.
    Type: String
    AllowedValues:
    - dev
    - test
    - prod
  pAnalyticsBucketARN:
    Description: ARN of analytics bucket that was created by the AMC Quickstart cloud
      formation template
    Type: AWS::SSM::Parameter::Value<String>
    Default: /SDLF/S3/AnalyticsBucket
  pAMCGlueDataCatalogName:
    Description: Name of the Glue Data Catalog that was created by the AMC Quickstart
      Cloud Formation Template
    Type: AWS::SSM::Parameter::Value<String>
    Default: /SDLF/S3/AthenaBucket
  pStagingBucketARN:
    Description: Name of the Staging bucket that contains the data for the glue data
      catalog
    Type: AWS::SSM::Parameter::Value<String>
    Default: /SDLF/S3/StageBucket
  pSnsEmailSubscriber:
    Description: The email address that receives notifications from the created SNS
      topic.
    Type: String
    Default: nobody@nobody.com
  pPipelineName:
    Description: The name of the Pipeline (all lowercase, no symbols or spaces)
    Type: String
    AllowedPattern: '[a-z0-9]{2,10}'
  pAthenaResultsS3BucketName:
    Type: AWS::SSM::Parameter::Value<String>
    Default: /SDLF/S3/AthenaBucket
  pKMSKeyId:
    Type: AWS::SSM::Parameter::Value<String>
    Default: /SDLF/KMS/KeyArn
  pDatasetName:
    Description: The Dataset Name
    Type: String
Globals:
  Function:
    Handler: lambda_function.lambda_handler
Resources:
  rAthenaWorkgroupStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://s3.amazonaws.com/sdlf-cfn-artifacts-us-east-1-777944859732/wfm/pipeline/dlhs/7243bd4d972b40a0a9f4a6863e647a3a.template
      Parameters:
        pTeamName:
          Ref: pTeamName
        pMicroserviceName:
          Ref: pMicroserviceName
        pPipelineName:
          Ref: pPipelineName
        pAthenaResultsS3BucketName:
          Ref: pAthenaResultsS3BucketName
        pEnvironment:
          Ref: pEnvironment
      Tags:
      - Key: tagging-policy
        Value:
          Fn::Join:
          - '-'
          - - Ref: pMicroserviceName
            - Ref: pTeamName
            - Ref: pEnvironment
  rDynamoDBStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://s3.amazonaws.com/sdlf-cfn-artifacts-us-east-1-777944859732/wfm/pipeline/dlhs/f9ba89dfafc24141c024406ebe049d21.template
      Parameters:
        pTeamName:
          Ref: pTeamName
        pMicroserviceName:
          Ref: pMicroserviceName
        pPipelineName:
          Ref: pPipelineName
        pKMSKeyId:
          Ref: pKMSKeyId
      Tags:
      - Key: tagging-policy
        Value:
          Fn::Join:
          - '-'
          - - Ref: pMicroserviceName
            - Ref: pTeamName
            - Ref: pEnvironment
  rIAMStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://s3.amazonaws.com/sdlf-cfn-artifacts-us-east-1-777944859732/wfm/pipeline/dlhs/c453568cc31a3ae41e5a57b91aefe7a7.template
      Parameters:
        pTeamName:
          Ref: pTeamName
        pMicroserviceName:
          Ref: pMicroserviceName
        pEnvironment:
          Ref: pEnvironment
        pAnalyticsBucketARN:
          Ref: pAnalyticsBucketARN
        pAMCGlueDataCatalogName:
          Fn::Sub: '{{resolve:ssm:/SDLF/Glue/${pTeamName}/${pDatasetName}/StageDataCatalog}}'
        pStagingBucketARN:
          Ref: pStagingBucketARN
        pPipelineName:
          Ref: pPipelineName
        pDynamoDBCustomerConfig:
          Fn::GetAtt:
          - rDynamoDBStack
          - Outputs.oDynamoDBCustomerConfig
        pDynamoDBCustomerConfigStreamArn:
          Fn::GetAtt:
          - rDynamoDBStack
          - Outputs.oDynamoDBCustomerConfigStreamArn
        pDynamoDBAMCExecutionStatus:
          Fn::GetAtt:
          - rDynamoDBStack
          - Outputs.oDynamoDBAMCExecutionStatus
        pDynamoDBAMCExecutionStatusStreamArn:
          Fn::GetAtt:
          - rDynamoDBStack
          - Outputs.oDynamoDBAMCExecutionStatusStreamArn
        pDynamoDBAMCWorkflows:
          Fn::GetAtt:
          - rDynamoDBStack
          - Outputs.oDynamoDBAMCWorkflows
        pDynamoDBAMCWorkflowsStreamArn:
          Fn::GetAtt:
          - rDynamoDBStack
          - Outputs.oDynamoDBAMCWorkflowsStreamArn
        pDynamoDBAMCWorkflowSchedules:
          Fn::GetAtt:
          - rDynamoDBStack
          - Outputs.oDynamoDBAMCWorkflowSchedules
        pDynamoDBAMCWorkflowSchedulesStreamArn:
          Fn::GetAtt:
          - rDynamoDBStack
          - Outputs.oDynamoDBAMCWorkflowSchedulesStreamArn
        pSNSSQSKey:
          Ref: pKMSKeyId
        pDynamoDBAMCWorkflowLibrary:
          Fn::GetAtt:
          - rDynamoDBStack
          - Outputs.oDynamoDBAMCWorkflowLibrary
        pDynamoDBAMCWorkflowLibraryStreamArn:
          Fn::GetAtt:
          - rDynamoDBStack
          - Outputs.oDynamoDBAMCWorkflowLibraryStreamArn
        pAthenaResultsS3BucketName:
          Ref: pAthenaResultsS3BucketName
        pAthenaWorkGroup:
          Fn::GetAtt:
          - rAthenaWorkgroupStack
          - Outputs.oAthenaWorkGroupName
        pAthenaWorkGroupS3OutputLocation:
          Fn::GetAtt:
          - rAthenaWorkgroupStack
          - Outputs.oAthenaWorkGroupS3OutputLocation
        pTPSIntegrationKMSKeyARN:
          Ref: pKMSKeyId
        pWLSIntegrationKMSKeyARN:
          Ref: pKMSKeyId
        pSnsTopic:
          Ref: rSnsTopic
  rLambdaStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://s3.amazonaws.com/sdlf-cfn-artifacts-us-east-1-777944859732/wfm/pipeline/dlhs/0c822f61b0d14d01609e155ef5eae532.template
      Parameters:
        pTeamName:
          Ref: pTeamName
        pMicroserviceName:
          Ref: pMicroserviceName
        pPipelineName:
          Ref: pPipelineName
        pEnvironment:
          Ref: pEnvironment
        pDynamoDBCustomerConfig:
          Fn::GetAtt:
          - rDynamoDBStack
          - Outputs.oDynamoDBCustomerConfig
        pDynamoDBCustomerConfigStreamArn:
          Fn::GetAtt:
          - rDynamoDBStack
          - Outputs.oDynamoDBCustomerConfigStreamArn
        pDynamoDBAMCExecutionStatus:
          Fn::GetAtt:
          - rDynamoDBStack
          - Outputs.oDynamoDBAMCExecutionStatus
        pDynamoDBAMCExecutionStatusStreamArn:
          Fn::GetAtt:
          - rDynamoDBStack
          - Outputs.oDynamoDBAMCExecutionStatusStreamArn
        pDynamoDBAMCWorkflows:
          Fn::GetAtt:
          - rDynamoDBStack
          - Outputs.oDynamoDBAMCWorkflows
        pDynamoDBAMCWorkflowsStreamArn:
          Fn::GetAtt:
          - rDynamoDBStack
          - Outputs.oDynamoDBAMCWorkflowsStreamArn
        pDynamoDBAMCWorkflowSchedules:
          Fn::GetAtt:
          - rDynamoDBStack
          - Outputs.oDynamoDBAMCWorkflowSchedules
        pDynamoDBAMCWorkflowSchedulesStreamArn:
          Fn::GetAtt:
          - rDynamoDBStack
          - Outputs.oDynamoDBAMCWorkflowSchedulesStreamArn
        pRoleLambdaAmcApiInterface:
          Fn::GetAtt:
          - rIAMStack
          - Outputs.oRoleLambdaAmcApiInterface
        pRoleLambdaSyncWorkflowStatuses:
          Fn::GetAtt:
          - rIAMStack
          - Outputs.oRoleLambdaSyncWorkflowStatuses
        pRoleLambdaWorkflowStatusTrigger:
          Fn::GetAtt:
          - rIAMStack
          - Outputs.oRoleLambdaWorkflowStatusTrigger
        pRoleLambdaWorkflowTableTrigger:
          Fn::GetAtt:
          - rIAMStack
          - Outputs.oRoleLambdaWorkflowTableTrigger
        pRoleLambdaEventQueueConsumer:
          Fn::GetAtt:
          - rIAMStack
          - Outputs.oRoleLambdaEventQueueConsumer
        pRoleLambdaEventQueueProducer:
          Fn::GetAtt:
          - rIAMStack
          - Outputs.oRoleLambdaEventQueueProducer
        pRoleLambdaRunWorkFlowByCampaign:
          Fn::GetAtt:
          - rIAMStack
          - Outputs.oRoleLambdaRunWorkFlowByCampaign
        pRoleLambdaWorkflowScheduleTrigger:
          Fn::GetAtt:
          - rIAMStack
          - Outputs.oRoleLambdaWorkflowScheduleTrigger
        pRoleLambdaCustomerConfigTrigger:
          Fn::GetAtt:
          - rIAMStack
          - Outputs.oRoleLambdaCustomerConfigTrigger
        pRoleLambdaCustomerConfigQueueConsumer:
          Fn::GetAtt:
          - rIAMStack
          - Outputs.oRoleLambdaCustomerConfigQueueConsumer
        pRoleLambdaWorkflowLibraryQueueConsumer:
          Fn::GetAtt:
          - rIAMStack
          - Outputs.oRoleLambdaWorkflowLibraryQueueConsumer
        pAthenaWorkGroup:
          Fn::GetAtt:
          - rAthenaWorkgroupStack
          - Outputs.oAthenaWorkGroupName
        pAthenaWorkGroupS3OutputLocation:
          Fn::GetAtt:
          - rAthenaWorkgroupStack
          - Outputs.oAthenaWorkGroupS3OutputLocation
        pAPIGatewayInvokeAMCApiPolicy:
          Fn::GetAtt:
          - rIAMStack
          - Outputs.oAPIGatewayInvokeAMCApiPolicy
        pDynamoDBAMCWorkflowLibrary:
          Fn::GetAtt:
          - rDynamoDBStack
          - Outputs.oDynamoDBAMCWorkflowLibrary
        pDynamoDBAMCWorkflowLibraryStreamArn:
          Fn::GetAtt:
          - rDynamoDBStack
          - Outputs.oDynamoDBAMCWorkflowLibraryStreamArn
        pRoleLambdaWorkflowLibraryTrigger:
          Fn::GetAtt:
          - rIAMStack
          - Outputs.oRoleLambdaWorkflowLibraryTrigger
        pRoleLambdaGenerateExecutionResubmissions:
          Fn::GetAtt:
          - rIAMStack
          - Outputs.oRoleLambdaGenerateExecutionResubmissions
        pKMSKeyId:
          Ref: pKMSKeyId
        pRoleLambdaCustomScheduler:
          Fn::GetAtt:
          - rIAMStack
          - Outputs.oRoleLambdaCustomScheduler
        pPowerToolsLibLayer:
          Fn::Sub: '{{resolve:ssm:/SDLF/Lambda/${pTeamName}/PowerTools}}'
      Tags:
      - Key: tagging-policy
        Value:
          Fn::Join:
          - '-'
          - - Ref: pMicroserviceName
            - Ref: pTeamName
            - Ref: pEnvironment
  rCloudWatchStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://s3.amazonaws.com/sdlf-cfn-artifacts-us-east-1-777944859732/wfm/pipeline/dlhs/5ac3bdd2e5f3edcebb4e7543decc50a8.template
      Parameters:
        pTeamName:
          Ref: pTeamName
        pMicroserviceName:
          Ref: pMicroserviceName
        pPipelineName:
          Ref: pPipelineName
        pLambdaWorkflowExecutionQueueConsumer:
          Fn::GetAtt:
          - rLambdaStack
          - Outputs.oLambdaWorkflowExecutionQueueConsumer
        pLambdaAmcApiInterface:
          Fn::GetAtt:
          - rLambdaStack
          - Outputs.oLambdaAmcApiInterface
        pLambdaCustomScheduler:
          Fn::GetAtt:
          - rLambdaStack
          - Outputs.oLambdaCustomScheduler
      Tags:
      - Key: tagging-policy
        Value:
          Fn::Join:
          - '-'
          - - Ref: pMicroserviceName
            - Ref: pTeamName
            - Ref: pEnvironment
  rSnsTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName:
        Fn::Join:
        - '-'
        - - Ref: pMicroserviceName
          - Ref: pTeamName
          - Ref: pPipelineName
          - SNSTopic
      Subscription:
      - Endpoint:
          Ref: pSnsEmailSubscriber
        Protocol: email
      KmsMasterKeyId:
        Ref: pKMSKeyId
      Tags:
      - Key: tagging-policy
        Value:
          Fn::Join:
          - '-'
          - - Ref: pMicroserviceName
            - Ref: pTeamName
            - Ref: pPipelineName
            - common

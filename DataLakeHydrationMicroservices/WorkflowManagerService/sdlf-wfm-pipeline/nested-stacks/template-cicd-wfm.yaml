AWSTemplateFormatVersion: '2010-09-09'
Description: 'CodePipeline templates for the WFM'

Parameters:
  # pAppName:
  #   Type: String
  pArtifactoryStore:
    Type: String
  pBranchName:
    Type: String
  pBuildDatalakeLibrary:
    Type: "AWS::SSM::Parameter::Value<String>"
  pCloudWatchRepositoryTriggerRoleArn:
    Type: "AWS::SSM::Parameter::Value<String>"
  pCodePipelineRoleArn:
    Type: "AWS::SSM::Parameter::Value<String>"
  # pDatasetBucket:
  #   Type: String
  pEnv:
    Type: String
  pKMSInfraKeyId:
    Type: "AWS::SSM::Parameter::Value<String>"
  # pKMSDataKeyId:
  #   Type: "AWS::SSM::Parameter::Value<String>"
  # pOrgName:
  #   Type: String
  pPipeline:
    Type: String
  pRepositoryName:
    Type: String
  pSNSTopic:
    Type: "AWS::SSM::Parameter::Value<String>"
  # pSharedDevOpsAccountId:
  #   Type: String
  # pStageBucket:
  #   Type: String
  pTeamName:
    Type: String
  # pTransformValidateCodeBuildJob:
  #   Type: "AWS::SSM::Parameter::Value<String>"

Resources:
  ######## TPS Codebuild ########
  rCodeBuildRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub sdlf-cicd-codebuild-wfm-${AWS::Region}
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: sdlf-cicd-codebuild
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Resource: !Sub arn:aws:iam::${AWS::AccountId}:role/sdlf-cicd-foundations-codecommit-${pEnv}-${AWS::Region}
                Effect: Allow
                Action: sts:AssumeRole
              - Resource:
                  - !Sub arn:aws:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/sdlf-*
                  - !Sub arn:aws:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/tps-*
                  - !Sub arn:aws:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/wfm-*
                  - !Sub arn:aws:cloudformation:${AWS::Region}:aws:transform/*
                Effect: Allow
                Action:
                  - cloudformation:*
              - Resource: "*"
                Effect: Allow
                Action:
                  - cloudformation:GetTemplate
                  - cloudformation:GetTemplateSummary
                  - cloudformation:ListStacks
                  - cloudformation:ValidateTemplate
              - Resource: 
                  - !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/octagon-*
                  - !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/tps-*
                  - !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/sdlf-*
                  - !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/wfm-*
                Effect: Allow
                Action:
                  - dynamodb:*
              - Resource: 
                  - !Sub arn:aws:events:${AWS::Region}:${AWS::AccountId}:rule/sdlf-*
                  - !Sub arn:aws:events:${AWS::Region}:${AWS::AccountId}:rule/tps-*
                  - !Sub arn:aws:events:${AWS::Region}:${AWS::AccountId}:rule/wfm-*
                Effect: Allow
                Action:
                  - events:*
              - Resource: !Sub arn:aws:iam::${AWS::AccountId}:role/*
                Effect: Allow
                Action: iam:PassRole
                Condition:
                  StringEqualsIfExists:
                    iam:PassedToService:
                      - cloudformation.amazonaws.com
                      - codebuild.amazonaws.com
                      - codepipeline.amazonaws.com
                      - lambda.amazonaws.com
              - Resource: "*"
                Effect: Allow
                Action:
                  - iam:*
              - Resource: 
                  - !Sub arn:aws:iam::${AWS::AccountId}:role/sdlf*
                  - !Sub arn:aws:iam::${AWS::AccountId}:role/tps*
                  - !Sub arn:aws:iam::${AWS::AccountId}:role/wfm*
                Effect: Allow
                Action: iam:PassRole
              - Resource:
                  - !Sub arn:aws:iam::${AWS::AccountId}:role/sdlf-*
                  - !Sub arn:aws:iam::${AWS::AccountId}:role/tps-*
                  - !Sub arn:aws:iam::${AWS::AccountId}:role/wfm-*
                  - !Sub arn:aws:iam::${AWS::AccountId}:role/aws-service-role/*
                  - !Sub arn:aws:iam::${AWS::AccountId}:role/service-role/*
                  - !Sub arn:aws:iam::${AWS::AccountId}:role/state-machine/sdlf-*
                  - !Sub arn:aws:iam::${AWS::AccountId}:role/state-machine/tps-*
                  - !Sub arn:aws:iam::${AWS::AccountId}:role/state-machine/wfm-*
                Effect: Allow
                Action:
                  - iam:*
              - Resource: 
                  - !Sub arn:aws:iam::${AWS::AccountId}:policy/sdlf-*
                  - !Sub arn:aws:iam::${AWS::AccountId}:policy/tps-*
                  - !Sub arn:aws:iam::${AWS::AccountId}:policy/wfm-*
                Effect: Allow
                Action:
                  - iam:*
              - Resource: "*"
                Effect: "Allow"
                Action: lambda:ListFunctions
              - Resource: 
                  - !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:sdlf-*
                  - !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:tps-*
                  - !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:layer:sdlf-*
                  - !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:layer:tps-*
                  - !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:wfm-*
                  - !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:layer:wfm-*
                Effect: Allow
                Action:
                  - lambda:*
              - Resource: "*"
                Effect: "Allow"
                Action:
                  - lambda:CreateEventSourceMapping
                  - lambda:GetEventSourceMapping
                  - lambda:UpdateEventSourceMapping
                  - lambda:DeleteEventSourceMapping
              - Resource: "*"
                Effect: Allow
                Action:
                  - states:*
              - Resource: 
                  - !Sub "arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:sdlf-*"
                  - !Sub "arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:tps-*"
                  - !Sub "arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:wfm-*"
                Effect: Allow
                Action:
                  - states:DeleteStateMachine
                  - states:DescribeStateMachine
                  - states:UpdateStateMachine
              - Resource: "*"
                Effect: "Allow"
                Action:
                  - logs:CreateLogGroup
                  - logs:DescribeLogGroups
              - Resource:
                  - !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:sdlf-*:log-stream:*
                  - !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/sdlf-*:log-stream:*
                  - !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/codebuild/sdlf-*:log-stream:*
                  - !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:tps-*:log-stream:*
                  - !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/tps-*:log-stream:*
                  - !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/codebuild/tps-*:log-stream:*
                  - !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:wfm-*:log-stream:*
                  - !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/wfm-*:log-stream:*
                  - !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/codebuild/wfm-*:log-stream:*
                Effect: Allow
                Action:
                  - logs:*
              - Resource: 
                  - !Sub arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:sdlf-*
                  - !Sub arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:tps-*
                  - !Sub arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:wfm-*
                Effect: Allow
                Action:
                  - cloudwatch:DeleteAlarms
                  - cloudwatch:DescribeAlarms
                  - cloudwatch:DisableAlarmActions
                  - cloudwatch:EnableAlarmActions
                  - cloudwatch:GetMetricData
                  - cloudwatch:PutMetricAlarm
                  - cloudwatch:PutMetricData
                  - cloudwatch:SetAlarmState
              - Resource: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:*
                Effect: Allow
                Action: sns:ListTopics
              - Resource: 
                  - !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:sdlf-*
                  - !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:tps-*
                  - !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:wfm-*
                Effect: Allow
                Action:
                  - sns:*
              - Resource: "*"
                Effect: Allow
                Action:
                  - s3:CreateBucket
                  - s3:DeleteBucket
                  - s3:DeleteBucketPolicy
                  - s3:GetBucketAcl
                  - s3:GetBucketPolicy
                  - s3:GetEncryptionConfiguration
                  - s3:GetObject
                  - s3:ListBucket
                  - s3:ListBuckets
                  - s3:ListObjects
                  - s3:ListObjectsV2
                  - s3:PutBucketAcl
                  - s3:PutBucketEncryption
                  - s3:PutBucketLogging
                  - s3:PutBucketNotification
                  - s3:PutBucketPolicy
                  - s3:PutBucketPublicAccessBlock
                  - s3:PutBucketTagging
                  - s3:PutBucketVersioning
                  - s3:PutEncryptionConfiguration
                  - s3:PutObject
                  - s3:SetBucketEncryption
              - Resource: 
                  - !Sub arn:aws:codebuild:${AWS::Region}:${AWS::AccountId}:project/sdlf-*
                  - !Sub arn:aws:codebuild:${AWS::Region}:${AWS::AccountId}:project/tps-*
                  - !Sub arn:aws:codebuild:${AWS::Region}:${AWS::AccountId}:project/wfm-*
                Effect: Allow
                Action:
                  - codebuild:BatchGetProjects
                  - codebuild:BatchGetBuilds
                  - codebuild:CreateProject
                  - codebuild:DeleteProject
                  - codebuild:UpdateProject
              - Resource: 
                  - !Sub arn:aws:codepipeline:${AWS::Region}:${AWS::AccountId}:sdlf-*
                  - !Sub arn:aws:codepipeline:${AWS::Region}:${AWS::AccountId}:tps-*
                  - !Sub arn:aws:codepipeline:${AWS::Region}:${AWS::AccountId}:wfm-*
                Effect: Allow
                Action:
                  - codepipeline:CreatePipeline
                  - codepipeline:DeletePipeline
                  - codepipeline:GetPipelineState
                  - codepipeline:GetPipeline
                  - codepipeline:UpdatePipeline
              - Resource: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:*
                Effect: Allow
                Action: sqs:ListQueues
              - Resource: 
                  - !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:sdlf-*
                  - !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:tps-*
                  - !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:wfm-*
                Effect: Allow
                Action:
                  - sqs:*
              - Resource: 
                  - "*"
                Effect: Allow
                Action:
                  - athena:*
              - Resource: !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/SDLF/*
                Effect: Allow
                Action:
                  - ssm:AddTagsToResource
                  - ssm:DeleteParameter
                  - ssm:DeleteParameters
                  - ssm:DescribeParameters
                  - ssm:GetOpsSummary
                  - ssm:GetParameter
                  - ssm:GetParameterHistory
                  - ssm:GetParameters
                  - ssm:GetParametersByPath
                  - ssm:ListTagsForResource
                  - ssm:PutParameter
                  - ssm:RemoveTagsFromResource
              - Resource: "*"
                Effect: Allow
                Action:
                  - lakeformation:DeregisterResource
                  - lakeformation:GetDataAccess
                  - lakeformation:GrantPermissions
                  - lakeformation:PutDataLakeSettings
                  - lakeformation:RegisterResource
                  - lakeformation:RevokePermissions
                  - lakeformation:UpdateResource
              - Resource: "*"
                Effect: Allow
                Action:
                  - cloudtrail:DescribeTrails
              - Resource: 
                  - !Sub arn:aws:cloudtrail:${AWS::Region}:${AWS::AccountId}:trail/sdlf-*
                  - !Sub arn:aws:cloudtrail:${AWS::Region}:${AWS::AccountId}:trail/tps-*
                  - !Sub arn:aws:cloudtrail:${AWS::Region}:${AWS::AccountId}:trail/wfm-*
                Effect: Allow
                Action:
                  - cloudtrail:AddTags
                  - cloudtrail:CreateTrail
                  - cloudtrail:DeleteTrail
                  - cloudtrail:ListTags
                  - cloudtrail:PutEventSelectors
                  - cloudtrail:RemoveTags
                  - cloudtrail:StartLogging
                  - cloudtrail:StopLogging
                  - cloudtrail:UpdateTrail
              - Resource: "*"
                Effect: Allow
                Action:
                  - kms:CreateAlias
                  - kms:CreateKey
                  - kms:DeleteAlias
                  - kms:ListAliases
                  - kms:ListGrants
                  - kms:ListKeyPolicies
                  - kms:ListKeys
                  - kms:ListResourceTags
                  - kms:UpdateAlias
              - Resource:
                  - !Sub arn:aws:kms:${AWS::Region}:${AWS::AccountId}:key/*
                Effect: Allow
                Action:
                  - kms:CreateGrant
                  - kms:Decrypt
                  - kms:DescribeKey
                  - kms:DisableKey
                  - kms:DisableKeyRotation
                  - kms:EnableKey
                  - kms:EnableKeyRotation
                  - kms:Encrypt
                  - kms:GenerateDataKey
                  - kms:GetKeyPolicy
                  - kms:PutKeyPolicy
                  - kms:ReEncryptFrom
                  - kms:ReEncryptTo
                  - kms:RetireGrant
                  - kms:RevokeGrant
                  - kms:ScheduleKeyDeletion
                  - kms:TagResource
                  - kms:UntagResource
                  - kms:UpdateKeyDescription
              - Resource: "*"
                Effect: Allow
                Action:
                  - glue:CreateCrawler
                  - glue:CreateDatabase
                  - glue:CreateJob
                  - glue:CreateSecurityConfiguration
                  - glue:DeleteCrawler
                  - glue:DeleteDatabase
                  - glue:DeleteJob
                  - glue:DeleteSecurityConfiguration
                  - glue:Get*
                  - glue:PutDataCatalogEncryptionSettings
                  - glue:SearchTables
                  - glue:StopCrawler
                  - glue:TagResource
                  - glue:UntagResource
                  - glue:UpdateCrawler
                  - glue:UpdateDatabase
                  - glue:UpdateJob
              
  rWfmDeployProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: !Sub sdlf-${pTeamName}-cicd-wfm-pipeline
      Artifacts:
        Type: CODEPIPELINE
      EncryptionKey: !Ref pKMSInfraKeyId
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/standard:4.0
        Type: LINUX_CONTAINER
      ServiceRole: !Ref rCodeBuildRole
      TimeoutInMinutes: 20
      Source:
        Type: CODEPIPELINE
        BuildSpec: |
          version: 0.2
          phases:
            install:
              runtime-versions:
                  python: 3.7
            build:
              commands:
                - echo Configuring AWS credentials
                - echo AWS_CONTAINER_CREDENTIALS_RELATIVE_URI $AWS_CONTAINER_CREDENTIALS_RELATIVE_URI
                - curl -qL -o aws_credentials.json http://169.254.170.2/$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI > aws_credentials.json
                - aws configure set aws_access_key_id `jq -r '.AccessKeyId' aws_credentials.json`
                - aws configure set aws_secret_access_key `jq -r '.SecretAccessKey' aws_credentials.json`
                - aws configure set aws_session_token `jq -r '.Token' aws_credentials.json`
                - chmod +x ./*.sh
                - ./deploy.sh
          artifacts:
            files:
              - "*"
              - "**/*"
  ######## WFM PIPELINES ########
  rWfmPipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      RoleArn: !Ref pCodePipelineRoleArn
      Name: !Sub sdlf-${pTeamName}-cicd-wfm-pipeline
      Stages:
        -
          Name: Source
          Actions:
            -
              Name: Source
              RoleArn: !Sub arn:aws:iam::${AWS::AccountId}:role/sdlf-cicd-team-codecommit-${pEnv}-${pTeamName}-${AWS::Region}
              ActionTypeId:
                Category: Source
                Owner: AWS
                Version: '1'
                Provider: CodeCommit
              OutputArtifacts:
                - Name: SourceArtifact
              Configuration:
                RepositoryName: !Ref pRepositoryName
                BranchName: !Ref pBranchName
                PollForSourceChanges: "false"
              RunOrder: 1
        -
          Name: Build
          Actions:
            - Name: Build
              InputArtifacts:
              - Name: SourceArtifact
              ActionTypeId:
                Category: Build
                Owner: AWS
                Version: '1'
                Provider: CodeBuild
              OutputArtifacts:
                - Name: BuildArtifact
              Configuration:
                ProjectName: !Ref rWfmDeployProject
              RunOrder: 1 
      ArtifactStore:
        Type: S3
        EncryptionKey:
          Id: !Ref pKMSInfraKeyId
          Type: KMS
        Location: !Ref pArtifactoryStore

  rPipelineTriggerEventRule:
    Type: AWS::Events::Rule
    Properties:
      Description: !Sub "Run ${pTeamName} ${pPipeline} Pipeline on ${pRepositoryName} repository update"
      EventPattern:
        source:
          - aws.codecommit
        detail-type:
          - 'CodeCommit Repository State Change'
        resources:
          - !Sub "arn:aws:codecommit:${AWS::Region}:${AWS::AccountId}:${pRepositoryName}"
        detail:
          event:
            - referenceCreated
            - referenceUpdated
          referenceType:
            - branch
          referenceName:
            - !Ref pBranchName
      Targets:
        - Arn: !Sub "arn:aws:codepipeline:${AWS::Region}:${AWS::AccountId}:${rWfmDeployProject}"
          Id: !Sub "sdlf-${pTeamName}-${pPipeline}-${pRepositoryName}-trigger"
          RoleArn: !Ref pCloudWatchRepositoryTriggerRoleArn

  # rPipelineTriggerOnLayerUpdate:
  #   Type: AWS::Events::Rule
  #   Properties:
  #     Description: !Sub "Update ${pTeamName} ${pPipeline} Pipeline on layer update"
  #     EventPattern:
  #       source:
  #         - aws.codebuild
  #       detail-type:
  #         - 'CodeBuild Build State Change'
  #       detail:
  #         build-status:
  #           - SUCCEEDED
  #         project-name:
  #           - !Ref pBuildDatalakeLibrary
  #     Targets:
  #       - Arn: !Sub "arn:aws:codepipeline:${AWS::Region}:${AWS::AccountId}:${rTpsPipeline}"
  #         Id: !Sub "sdlf-${pTeamName}-${pPipeline}-${pRepositoryName}-update"
  #         RoleArn: !Ref pCloudWatchRepositoryTriggerRoleArn

  rPipelineFailedRule:
    Type: AWS::Events::Rule
    Properties:
      Description: !Sub "Notify ${pTeamName} team of ${pPipeline} pipeline failure"
      EventPattern:
        source:
          - aws.codepipeline
        detail-type:
          - CodePipeline Pipeline Execution State Change
        detail:
          state:
            - FAILED
          pipeline:
            - !Ref rWfmPipeline
      State: "ENABLED"
      Targets:
        - Arn: !Ref pSNSTopic
          Id: !Sub "sdlf-${pTeamName}-${pPipeline}-${pRepositoryName}-failure"
          InputTransformer:
            InputTemplate: !Sub '"The Pipeline <pipeline> has failed. Go to https://console.aws.amazon.com/codepipeline/home?region=${AWS::Region}#/view/${rWfmPipeline}"'
            InputPathsMap:
              pipeline: $.detail.pipeline